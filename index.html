<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kalkulator Interaktif</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --wood: #e8d7b9;
        --wood-dark: #c9b392;
        --paper: #ffffff;
        --paper-soft: #f7f4ef;
        --ink: #2f2f2f;
        --ink-soft: #4a4a4a;
        --accent-red: #c45b5b;
      }

      .shoji-frame {
        background: var(--wood);
        border: 6px solid var(--wood-dark);
        border-radius: 20px;
        position: relative;
        padding: 20px;
      }

      .shoji-frame::before {
        content: "";
        position: absolute;
        inset: 0;
        background: repeating-linear-gradient(
          to right,
          transparent 0,
          transparent 180px,
          var(--wood-dark) 180px,
          var(--wood-dark) 185px
        );
        opacity: 0.3;
        pointer-events: none;
        border-radius: inherit;
      }

      .btn {
        background: var(--paper-soft);
        color: var(--ink);
        border-radius: 10px;
        border: 2px solid var(--wood-dark);
        transition: 0.2s;
      }

      .btn:hover {
        background: var(--paper);
      }

      .btn:active {
        background: var(--wood);
      }

      .btn.memory {
        background: #fefaf3;
      }

      .btn.operator {
        background: var(--wood-dark);
        color: white;
      }

      .btn.operator:hover {
        background: #b19a78;
      }

      .btn.clear {
        background: var(--accent-red);
        color: white;
        border-color: #8a3b3b;
      }

      .btn.equals {
        background: #4b6845;
        color: white;
        border-color: #2f402c;
      }

      #display {
        background: var(--paper);
        border: 3px solid var(--wood-dark);
        border-radius: 12px;
        padding: 20px;
      }

      #expression {
        color: var(--ink-soft);
      }

      #historyList div {
        background: var(--paper);
        border: 2px solid var(--wood-dark);
      }

      .history-list::-webkit-scrollbar {
        width: 6px;
      }
      .history-list::-webkit-scrollbar-thumb {
        background: #bbb;
        border-radius: 3px;
      }

      body {
        background: #fdfcf9;
      }
    </style>
  </head>

  <body class="min-h-screen flex items-center justify-center p-6">

    <div class="absolute top-6 text-[var(--ink)]">
      <h1 class="text-4xl font-bold tracking-wide">Kalkulator Interaktif</h1>
    </div>

    <div class="shoji-frame w-full max-w-6xl mx-auto flex flex-col md:flex-row gap-6">

      <div class="w-full md:w-2/3">

        <div class="mb-4">
          <div id="memoryIndicator" class="text-sm font-semibold text-[var(--ink)]"></div>

          <div id="display" class="text-right text-5xl font-bold text-[var(--ink)] shadow-sm">
            0
          </div>

          <div id="expression" class="text-right mt-1 text-sm min-h-5"></div>
        </div>

        <div class="grid grid-cols-4 gap-3">

          <button class="btn memory py-3" data-action="mc">MC</button>
          <button class="btn memory py-3" data-action="mr">MR</button>
          <button class="btn memory py-3" data-action="m-">M-</button>
          <button class="btn memory py-3" data-action="m+">M+</button>

          <button class="btn clear py-3" data-action="ce">CE</button>
          <button class="btn clear py-3" data-action="c">C</button>
          <button class="btn operator py-3" data-operator="/">÷</button>
          <button class="btn operator py-3" data-operator="*">×</button>

          <button class="btn number py-3" data-number="7">7</button>
          <button class="btn number py-3" data-number="8">8</button>
          <button class="btn number py-3" data-number="9">9</button>
          <button class="btn operator py-3" data-operator="-">-</button>

          <button class="btn number py-3" data-number="4">4</button>
          <button class="btn number py-3" data-number="5">5</button>
          <button class="btn number py-3" data-number="6">6</button>
          <button class="btn operator py-3" data-operator="+">+</button>

          <button class="btn number py-3" data-number="1">1</button>
          <button class="btn number py-3" data-number="2">2</button>
          <button class="btn number py-3" data-number="3">3</button>

          <button class="btn equals row-span-2 flex items-center justify-center text-xl py-3" data-action="=">=</button>

          <button class="btn number col-span-2 py-3" data-number="0">0</button>
          <button class="btn decimal py-3" data-action=".">.</button>

        </div>
      </div>

      <div class="w-full md:w-1/3 bg-[var(--paper-soft)] border-4 border-[var(--wood-dark)] rounded-xl p-4 shadow-inner">

        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-semibold text-[var(--ink)]">Riwayat Perhitungan</h3>
          <button id="clearHistory" class="text-[var(--accent-red)] font-semibold hover:underline">Hapus</button>
        </div>

        <div id="historyList" class="history-list max-h-96 overflow-y-auto pr-2 text-[var(--ink-soft)]">
          <p class="no-history">Tidak ada riwayat</p>
        </div>
      </div>

    </div>

    <script>
      let currentValue = '0';
      let expressionChain = [];
      let waitingForOperand = false;
      let memory = 0;
      let history = [];
      const MAX_HISTORY = 5;

      const display = document.getElementById('display');
      const expression = document.getElementById('expression');
      const memoryIndicator = document.getElementById('memoryIndicator');
      const historyList = document.getElementById('historyList');
      const clearHistoryBtn = document.getElementById('clearHistory');

      document.addEventListener('DOMContentLoaded', () => {
        loadHistory();
        updateDisplay();
        attachEventListeners();
      });

      function attachEventListeners() {
        document.querySelectorAll('.btn.number').forEach((btn) => {
          btn.addEventListener('click', () => handleNumber(btn.dataset.number));
        });

        document.querySelectorAll('.btn.operator').forEach((btn) => {
          btn.addEventListener('click', () => handleOperator(btn.dataset.operator));
        });

        document.querySelectorAll('[data-action]').forEach((btn) => {
          btn.addEventListener('click', () => handleAction(btn.dataset.action));
        });

        clearHistoryBtn.addEventListener('click', clearAllHistory);
        document.addEventListener('keydown', handleKeyboard);
      }

      function handleNumber(num) {
        if (waitingForOperand) {
          currentValue = num;
          waitingForOperand = false;
        } else {
          if (currentValue === '0' || currentValue === 'Error') currentValue = num;
          else currentValue += num;
        }
        updateDisplay();
      }

      function handleOperator(nextOperator) {
        const inputValue = parseFloat(currentValue);
        if (isNaN(inputValue)) return;

        if (waitingForOperand && expressionChain.length > 0) {
          expressionChain[expressionChain.length - 1] = nextOperator;
        } else {
          expressionChain.push(inputValue);
          expressionChain.push(nextOperator);
        }

        waitingForOperand = true;
        updateExpression();
      }

      function handleAction(action) {
        switch (action) {
          case '=': handleEquals(); break;
          case 'c': clearAll(); break;
          case 'ce': clearEntry(); break;
          case '.': handleDecimal(); break;
          case 'mc': memoryClear(); break;
          case 'mr': memoryRecall(); break;
          case 'm+': memoryAdd(); break;
          case 'm-': memorySubtract(); break;
        }
      }

      function handleEquals() {
        if (expressionChain.length === 0) return;

        const inputValue = parseFloat(currentValue);
        if (isNaN(inputValue)) return;

        if (expressionChain.length % 2 === 0) expressionChain.push(inputValue);

        const result = evaluateExpression(expressionChain);

        if (result === 'Error') {
          currentValue = 'Error';
          updateDisplay();
          setTimeout(() => clearAll(), 2000);
          return;
        }

        addToHistory(formatExpressionForHistory(expressionChain), result);

        currentValue = String(result);
        expressionChain = [];
        waitingForOperand = true;
        expression.textContent = '';
        updateDisplay();
      }

      function evaluateExpression(chain) {
        if (chain.length === 0) return 0;
        if (chain.length === 1) return chain[0];

        let expr = [...chain];

        let i = 1;
        while (i < expr.length) {
          const operator = expr[i];
          if (operator === '*' || operator === '/') {
            const left = expr[i - 1];
            const right = expr[i + 1];
            if (operator === '/' && right === 0) return 'Error';
            const result = operator === '*' ? left * right : left / right;
            expr.splice(i - 1, 3, result);
          } else i += 2;
        }

        i = 1;
        while (i < expr.length) {
          const operator = expr[i];
          if (operator === '+' || operator === '-') {
            const left = expr[i - 1];
            const right = expr[i + 1];
            const result = operator === '+' ? left + right : left - right;
            expr.splice(i - 1, 3, result);
          } else i += 2;
        }

        return Math.round(expr[0] * 100000000) / 100000000;
      }

      function formatExpressionForHistory(chain) {
        let result = '';
        for (let i = 0; i < chain.length; i++) {
          result += i % 2 === 0 ? chain[i] : ' ' + getOperatorSymbol(chain[i]) + ' ';
        }
        return result;
      }

      function clearAll() {
        currentValue = '0';
        expressionChain = [];
        waitingForOperand = false;
        expression.textContent = '';
        updateDisplay();
      }

      function clearEntry() {
        currentValue = '0';
        updateDisplay();
      }

      function handleDecimal() {
        if (currentValue === 'Error') currentValue = '0';
        if (waitingForOperand) {
          currentValue = '0.';
          waitingForOperand = false;
        } else if (!currentValue.includes('.')) currentValue += '.';
        updateDisplay();
      }

      function memoryClear() {
        memory = 0; updateMemoryIndicator();
      }

      function memoryRecall() {
        currentValue = String(memory);
        waitingForOperand = true;
        updateDisplay();
      }

      function memoryAdd() {
        memory += parseFloat(currentValue);
        updateMemoryIndicator();
      }

      function memorySubtract() {
        memory -= parseFloat(currentValue);
        updateMemoryIndicator();
      }

      function updateMemoryIndicator() {
        memoryIndicator.textContent = memory !== 0 ? 'M' : '';
      }

      function addToHistory(expr, result) {
        history.unshift({ expression: expr, result, timestamp: Date.now() });
        if (history.length > MAX_HISTORY) history = history.slice(0, MAX_HISTORY);
        saveHistory();
        renderHistory();
      }

      function renderHistory() {
        historyList.innerHTML = '';
        if (history.length === 0) {
          historyList.innerHTML = '<p class="no-history text-green-900">Belum ada riwayat</p>';
          return;
        }

        history.forEach(item => {
          const div = document.createElement('div');
          div.className = "p-3 mb-2 bg-white/60 rounded-xl shadow cursor-pointer hover:bg-white";
          div.innerHTML = `
            <div class="text-sm">${item.expression}</div>
            <div class="font-bold">= ${item.result}</div>
          `;
          div.addEventListener('click', () => {
            currentValue = String(item.result);
            waitingForOperand = true;
            updateDisplay();
          });

          historyList.appendChild(div);
        });
      }

      function clearAllHistory() {
        if (confirm('Hapus semua riwayat perhitungan?')) {
          history = [];
          saveHistory();
          renderHistory();
        }
      }

      function saveHistory() {
        localStorage.setItem('calculatorHistory', JSON.stringify(history));
      }

      function loadHistory() {
        const saved = localStorage.getItem('calculatorHistory');
        if (saved) {
          history = JSON.parse(saved);
          renderHistory();
        }
      }

      function handleKeyboard(e) {
        e.preventDefault();
        if (e.key >= '0' && e.key <= '9') handleNumber(e.key);
        else if (['+', '-', '*', '/'].includes(e.key)) handleOperator(e.key);
        else if (e.key === 'Enter' || e.key === '=') handleEquals();
        else if (e.key === '.' || e.key === ',') handleDecimal();
        else if (e.key === 'Escape') clearAll();
        else if (e.key === 'Backspace') {
          if (currentValue.length > 1) currentValue = currentValue.slice(0, -1);
          else currentValue = '0';
          updateDisplay();
        }
      }

      function updateDisplay() {
        display.textContent = formatNumber(currentValue);
      }

      function updateExpression() {
        if (expressionChain.length > 0) {
          expression.textContent = expressionChain
            .map((v, i) => i % 2 === 0 ? v : " " + getOperatorSymbol(v) + " ")
            .join("");
        } else expression.textContent = '';
      }

      function formatNumber(value) {
        if (value === 'Error') return 'Error: Tidak dapat dibagi 0';
        const num = parseFloat(value);
        if (isNaN(num)) return value;
        if (Math.abs(num) >= 1000)
          return num.toLocaleString("id-ID", { maximumFractionDigits: 8 });
        return value;
      }

      function getOperatorSymbol(op) {
        return { '+': '+', '-': '-', '*': '×', '/': '÷' }[op] || op;
      }

      document.querySelectorAll('.btn.operator').forEach((btn) => {
        btn.addEventListener('click', function () {
          document.querySelectorAll('.btn.operator').forEach((b) => b.classList.remove('active'));
          if (waitingForOperand) this.classList.add('active');
        });
      });

      document.querySelector('.btn.equals').addEventListener('click', () => {
        document.querySelectorAll('.btn.operator').forEach((b) => b.classList.remove('active'));
      });
    </script>

  </body>
</html>
